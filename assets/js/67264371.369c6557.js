"use strict";(self.webpackChunkvirtualclient=self.webpackChunkvirtualclient||[]).push([[4979],{1785:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var s=n(5893),r=n(3905);const i={},a="Sysbench OLTP Client/Server Lifecycle",o={id:"workloads/sysbench-oltp/sysbench-lifecycle",title:"Sysbench OLTP Client/Server Lifecycle",description:"All SQL workloads tend to have a lot of moving parts and complexities. Below details a comprehensive look into the lifecycle of this workload, in order to offer a clearer look as to what is happening under the hood when VC runs the Sysbench workload on a MySQL server.",source:"@site/docs/workloads/sysbench-oltp/sysbench-lifecycle.md",sourceDirName:"workloads/sysbench-oltp",slug:"/workloads/sysbench-oltp/sysbench-lifecycle",permalink:"/VirtualClient/docs/workloads/sysbench-oltp/sysbench-lifecycle",draft:!1,unlisted:!1,editUrl:"https://github.com/microsoft/VirtualClient/edit/main/website/docs/workloads/sysbench-oltp/sysbench-lifecycle.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Sysbench OLTP",permalink:"/VirtualClient/docs/workloads/sysbench-oltp/"},next:{title:"Sysbench OLTP Workload Profiles",permalink:"/VirtualClient/docs/workloads/sysbench-oltp/sysbench-oltp-profiles"}},l={},c=[{value:"MySQL Database Configuration",id:"mysql-database-configuration",level:2},{value:"Common MySQL Issues",id:"common-mysql-issues",level:3},{value:"Setting Up Disks",id:"setting-up-disks",level:2},{value:"About Sysbench",id:"about-sysbench",level:2},{value:"Parameters",id:"parameters",level:3},{value:"Server-Side Execution",id:"server-side-execution",level:2},{value:"Client-Side Execution",id:"client-side-execution",level:2},{value:"States",id:"states",level:2}];function h(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.ah)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.h1,{id:"sysbench-oltp-clientserver-lifecycle",children:"Sysbench OLTP Client/Server Lifecycle"}),"\n",(0,s.jsx)(t.p,{children:"All SQL workloads tend to have a lot of moving parts and complexities. Below details a comprehensive look into the lifecycle of this workload, in order to offer a clearer look as to what is happening under the hood when VC runs the Sysbench workload on a MySQL server."}),"\n",(0,s.jsx)(t.h2,{id:"mysql-database-configuration",children:"MySQL Database Configuration"}),"\n",(0,s.jsxs)(t.p,{children:["Using the ",(0,s.jsx)(t.a,{href:"/VirtualClient/docs/dependencies/0060-install-mysql",children:"LinuxPackageInstallation"})," and ",(0,s.jsx)(t.a,{href:"/VirtualClient/docs/dependencies/0060-install-mysql-database",children:"MySQLServerConfiguration"})," dependencies, VC can install and create a fresh, new database for the purpose of running Sysbench. Additionally, a user can provide their own database and skip database creation. However, if opting for this, take note that Sysbench will only successfully run against databases with its expected table naming conventions (ie. sbtest1, sbtest2, ...) and schema. That is, Sysbench will not run against any random database. Its workload scripts are specifically designed to recognize databases of a certain setup."]}),"\n",(0,s.jsx)(t.p,{children:"Regardless of if a user chooses to create a database through VC or bring their own, three MySQL commands are required for seamless Sysbench execution: RaisedStatementCount, ConfigureUser, and ConfigureNetwork (though the last two are not required for single-system runs). RaisedStatementCount increases the MySQL variable max_prepared_stmt_count to its maximum value, which is essential in Sysbench execution; the workload generator prepares MySQL statements in advance for execution, and if this variable is not high enough, Sysbench will fail even on reasonably high thread counts. The ConfigureUser setting grants all permissions to the client on the database; ConfigureNetwork edits the bind-address in /etc/mysql/mysql.conf.d/mysqld.cnf to allow for connections from other servers on the network."}),"\n",(0,s.jsx)(t.p,{children:"To run these commands manually, execute the following:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"# ConfigureNetwork commands\nsed -i \\\"s/.*bind-address.*/bind-address = {serverIPAddress}/\\\" /etc/mysql/mysql.conf.d/mysqld.cnf\nsystemctl restart mysql.service\n\n# CreateUser MySQL commands\nDROP USER IF EXISTS '{databaseName}'@'{clientIp}'\nCREATE USER '{databaseName}'@'{clientIp}'\nGRANT ALL ON *.* TO '{databaseName}'@'{clientIp}'\n\n# RaisedStatementCount MySQL command\nSET GLOBAL MAX_PREPARED_STMT_COUNT=100000;\n"})}),"\n",(0,s.jsx)(t.h3,{id:"common-mysql-issues",children:"Common MySQL Issues"}),"\n",(0,s.jsx)(t.p,{children:"Should VC throw an error that the MySQL server has failed to start, usually this means there an issue with the MySQL configuration file. The config file is a very delicate thing, and too many changes may altogether destroy the integrity of the service. From experience, it can be very difficult to debug and find a root cause for the service failing to start. In this case, it may be easiest to uninstall the MySQL server altogether an allow VC to re-install it. Furthermore, ensure that the state json (state/sysbencholtpstate.json) is removed on both the server and client; the SysbenchOLTPServerExecutor takes care of some required database preparation on its side, and should the state not be reset, the server will believe it ran MySQL configuration and bypass a necessary step. More on this later."}),"\n",(0,s.jsx)(t.p,{children:"To purge the mysql-server, run the following command:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"sudo apt-get purge --auto-remove mysql-server\n"})}),"\n",(0,s.jsx)(t.h2,{id:"setting-up-disks",children:"Setting Up Disks"}),"\n",(0,s.jsxs)(t.p,{children:["A user will likely want to run Sysbench on one or multiple disks. In that case, VC is able to ",(0,s.jsx)(t.a,{href:"/VirtualClient/docs/dependencies/0070-format-disks",children:"FormatDisks"})," and ",(0,s.jsx)(t.a,{href:"/VirtualClient/docs/dependencies/0071-mount-disks",children:"MountDisks"})," for the user. VC will then use the mount points it created to store the testing database. VC will run Sysbench on up to five disks."]}),"\n",(0,s.jsx)(t.h2,{id:"about-sysbench",children:"About Sysbench"}),"\n",(0,s.jsxs)(t.p,{children:["Sysbench prepares queries to test a MySQL server. Sysbench has various benchmark types (executed by lua scripts) it can run against the server, listed ",(0,s.jsx)(t.a,{href:"/VirtualClient/docs/workloads/sysbench-oltp/",children:"here"}),".\nSysbench exposes parameters that allow a user to execute the workload in single-server and client-server scenarios. However, any disk configuration must be done by the user themselves. That is, Sysbench does not expose any parameter to distribute the tables to one or multiple disks (ie. a data directory). If MySQL is not setup beforehand to prepare the server to put the database on one or multiple disks, Sysbench will go ahead and place the tables in the default location, the OS disk.\nSysbench also configures a few parameters, covered in depth below."]}),"\n",(0,s.jsx)(t.h3,{id:"parameters",children:"Parameters"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Threads"}),": The Sysbench workload generator prepares a list of statements to run on MySQL. MySQL can only accept so many prepared statements. We already max out this variable in a scenario in the MySQLConfiguation dependency, but even when setting the max_prepared_stmt_count to a large number, Sysbench can throw a 'too many connections' error. This has shown to be the case even on VMs with high core counts and equipped with the ability for high thread counts. User caution is advised for thread counts > 176; the VC team has only successfully seen Sysbench run with thread counts less than that number."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"RecordCount and NumTables"}),": Sysbench does not configure its database by size, only by record and table counts. The number of records can be configured in the Default scenario, and can be programmatically determined in the Balanced Scenario. More on what each scenario offers can be found in the ",(0,s.jsx)(t.a,{href:"/VirtualClient/docs/workloads/sysbench-oltp/sysbench-oltp-profiles",children:"profiles section"}),". Note: the select_random_* workloads only run on 1 table."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Duration"}),": Recommended execution time is 20 minutes; it is advised to run the workload for at least 10 to 15 minutes for stable, consistent results."]}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"If interested in running sysbench manually for familiarity reasons, here are examples of the three main commands VC executes with sysbench per execution (cleanup, prepare, and run) in a client-server scenario."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"# drops all existing tables in the given database\nsysbench oltp_common --tables=10 --table-size=100 --mysql-db=sbtest --mysql-host=1.2.3.4 cleanup\n\n# creates n fresh tables\nsysbench oltp_common --tables=10 --table-size=100 --mysql-db=sbtest --mysql-host=1.2.3.4 prepare\n\n# running the oltp_write_only workload\nsysbench oltp_write_only --threads=10 --tables=10 --table-size=100 --mysql-db=sbtest --mysql-host=1.2.3.4 --time=600 run\n"})}),"\n",(0,s.jsx)(t.h2,{id:"server-side-execution",children:"Server-Side Execution"}),"\n",(0,s.jsx)(t.p,{children:"The server side completes the following preparation steps before it listens on port 4500:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Initialize any variables, including DiskFilter."}),"\n",(0,s.jsx)(t.li,{children:"Check the current state if the DatabaseScenario has been initialized. If not, it will do so."}),"\n",(0,s.jsx)(t.li,{children:"In-Memory initialization involves running a script to increase buffer size in the MySQL config file. The new buffer size is programmatically determined as totalMemoryinKilobytes / 1024."}),"\n",(0,s.jsxs)(t.li,{children:["Balanced initialization finds any data disks attached and filters them on any given DiskFilter, along with the default OSDisk",":false"," filter. The server then executes a script to enable apparmor permissions for the mount points to those disks, for mysql to chown those directories, and for them to be set as recognized innodb_directories. These configurations are essential to distributing different tables on different disks with no issue."]}),"\n",(0,s.jsx)(t.li,{children:"The list of mount paths to the disks VC intends to use is then stored in the Sysbench state (to pass to the client for later use). The DatabaseScenario is set to initialized."}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"client-side-execution",children:"Client-Side Execution"}),"\n",(0,s.jsx)(t.p,{children:"The client side completes the following preparation steps before it runs the sysbench 'run' command:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"Initialize any variables, including Duration, DatabaseName, Workload, NumTables, RecordCount, and Threads."}),"\n",(0,s.jsx)(t.li,{children:"Since Sysbench is executed from the client-side, the SysbenchOLTPClientExecutor is also in charge of creating the tables (ie. 'prepare' command) too. The client programmatically determines if the table and record count are different than what exist on the given database. If the requested table or record counts are higher than what exist, the client will run the 'cleanup' and 'prepare' steps to populate the database on the server. If not, Sysbench will leave it alone."}),"\n",(0,s.jsx)(t.li,{children:"If running on the Balanced scenario, the client will ping the server state for the target disks' mount points, which will serve as the arguments to an executed script. This balanced-client.sh script runs a CREATE TABLE n times to create temporary tables, targeting a given mount point as the chosen DATA DIRECTORY, copying all the records in the sysbench-generated table over. This must be done as MySQL cannot create a table with a blank schema. Then, the old sbtestx tables are DROPped and the new ones on the disk are renamed to be the same title as the old tables. The tables are split evenly across the disks; ie. for 2 disks and 10 tables, there will be 5 tables on one and 5 on the other."}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"states",children:"States"}),"\n",(0,s.jsx)(t.p,{children:"In state/sysbencholtpstate.json, the SysbenchOLTPExecutors store information about certain initializations and data about the workload."}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"SysbenchInitialized"}),": Set to true by the client once the Sysbench package is initialized. If, under the packages/ directory there is not a sysbench folder, assure that this value does not exist in the json, or is set to false."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"ExecutablesInitialized"}),": Set to true by the client and server once the scripts (ex. balanced-server.sh, in-memory.sh, etc.) are set as executables. If, upon running one of these scripts, an error is thrown like 'command not found', assure that this value does not exist in the json, or is set to false."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"DatabaseScenarioInitialized"}),": Set to true by the server once the InMemory or Balanced setup scripts are run. If re-running the server under a different scenario, or if noting that the scenario preparation steps were skipped, assure that this value does not exist in the json, or is set to false."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"DiskPathsArgument"}),": Set to a string by the server, listing the set of mount points to the disks to distribute the MySQL server on. If, on the client side, when running the balanced-client.sh script, it throws an error that VC will only accept 1 to 5 data disks, assure that this value contains five or less mount points, or perhaps use a DiskFilter to filter down the disks in use."]}),"\n"]})]})}function d(e={}){const{wrapper:t}={...(0,r.ah)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},3905:(e,t,n)=>{n.d(t,{ah:()=>c});var s=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,s,r=function(e,t){if(null==e)return{};var n,s,r={},i=Object.keys(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(s=0;s<i.length;s++)n=i[s],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=s.createContext({}),c=function(e){var t=s.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):a(a({},t),e)),n},h={inlineCode:"code",wrapper:function(e){var t=e.children;return s.createElement(s.Fragment,{},t)}},d=s.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),u=c(n),b=r,p=u["".concat(l,".").concat(b)]||u[b]||h[b]||i;return n?s.createElement(p,a(a({ref:t},d),{},{components:n})):s.createElement(p,a({ref:t},d))}));d.displayName="MDXCreateElement"}}]);